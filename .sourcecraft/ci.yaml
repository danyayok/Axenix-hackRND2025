on:
  push:
    - workflows: [build-and-test-workflow]
      filter:
        branches: ["main"]
  pull_request:
    - workflows: [build-and-test-workflow]
      filter:
        target_branches: ["main"]

workflows:
  build-and-test-workflow:
    tasks:
      - build-and-test-task

tasks:
  - name: build-and-test-task
    cubes:
      # Сборка Docker образа
      - name: build-docker-image
        script:
          - cd backend
          - docker build -t axenix-backend .
      
      # Запуск Docker контейнера
      - name: run-docker-container
        script:
          - docker run -d --name axenix-app -p 8000:8000 axenix-backend
          # Ждем запуск приложения
          - sleep 10
      
      # Проверка работоспособности контейнера
      - name: check-container-running
        script:
          - docker ps | grep axenix-app
          # Проверяем, что приложение отвечает
          - curl -f http://localhost:8000/docs || (echo "App is not responding" && exit 1)
      
      # Установка Python для тестов
      - name: setup-python
        image: docker.io/library/python:3.11
        script:
          - python -m pip install --upgrade pip
      
      # Установка зависимостей для тестов
      - name: install-test-dependencies
        script:
          - pip install pytest requests
      
      # Запуск тестов
      - name: run-tests
        script:
          - cd backend
          - python tests.py
      
      # Остановка контейнера (всегда выполняется)
      - name: stop-container
        script:
          - docker stop axenix-app || true
          - docker rm axenix-app || true