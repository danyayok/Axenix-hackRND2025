# CI/CD конфигурация для сборки Docker-образа и деплоя через SSH

on:
  push:
    - workflows: [build-and-deploy]
      filter:
        branches: ["main"]

workflows:
  build-and-deploy:
    tasks:
      - build-and-push-task
      - deploy-task

tasks:
  - name: build-and-push-task
    env:
      IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/axenix
    cubes:
      - name: docker-build
        script:
          - echo "Building Docker image..."
          - docker build -t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
          - docker tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA $IMAGE_NAME:latest
      
      - name: docker-login
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        script:
          - echo "Logging in to Docker Hub..."
          - echo $DOCKER_PASSWORD | docker login --username $DOCKER_USERNAME --password-stdin
      
      - name: docker-push
        env:
          IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/axenix
        script:
          - echo "Pushing Docker image to registry..."
          - docker push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
          - docker push $IMAGE_NAME:latest
  
  - name: deploy-task
    cubes:
      - name: setup-ssh
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        script:
          - echo "Setting up SSH access..."
          - mkdir -p ~/.ssh
          - ssh-keyscan ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          - chmod 700 ~/.ssh
      
      - name: deploy-via-ssh
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/axenix
        script:
          - echo "Deploying via SSH..."
          - sshpass -p $SSH_PASSWORD ssh $SSH_USER@$SSH_HOST "docker pull $IMAGE_NAME:latest && docker stop axenix || true && docker rm axenix || true && docker run -d --name axenix -p 8080:8080 $IMAGE_NAME:latest"
